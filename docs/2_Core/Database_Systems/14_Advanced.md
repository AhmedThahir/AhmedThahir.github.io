## Syntax

### Window Functions

Faster and more readable alternative to self-joins

```
SELECT
	function(col_a) over w AS output
FROM table
WINDOW
	w AS ( PARTITION BY col_b ORDER BY col_c ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED SUCCEEDING )
QUALIFY output > 1
```

Note
- Use `ORDER BY NULL)` if ordering does not matter

3 types
- Navigation function
- Numbering function
- Aggregate functions

Running totals

```mysql
-- risky default
SUM(gmv_amount_lc) OVER( PARTITION BY account_id ORDER BY order_id )
SUM(gmv_amount_lc) OVER( PARTITION BY account_id ORDER BY order_id RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) -- equivalent

-- better
SUM(gmv_amount_lc) OVER( PARTITION BY account_id ORDER BY order_id ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)
```

### Joins

- Semi join
- Anti join
	- `LEFT JOIN b where b.account_id IS NULL`
	- `NOT EXISTS`
	- `NOT IN`
- Correlated subquery
- Except all

### Approx Functions

- `APPROX_COUNT_DISTINCT`
- `HYPERLOGLOG++`, etc

## Validation

- Fan-out?
	- Ideally, all these should be equal
		- `COUNT(*)`
		- `COUNT(primary_key)`
			- Use this for best readability, and check with the others
		- `COUNT(DISTINCT primary_key)`
		- `COUNT(1)`
- Numbers?
	- Decompose binary outcomes into components and verify if they add up

## Performance

|                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Wrong                                                                                                                                                                                                                                                                                                                                                                                                                         | Correct                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| ------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                                   | Expressions in your WHERE clauses should be ordered with the most selective expression first                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|                                                   | Better to specify that dates are dates                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `'2025-01-01'`                                                                                                                                                                                                                                                                                                                                                                                                                | `DATE '2025-01-01'`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|                                                   | Use partitioning and clustering                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                               | ![](assets/Pasted%20image%2020260117152834.png)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|                                                   | Do not perform functions on filter partition columns                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `DATETRUNC(order_date, MONTH) BETWEEN DATE '2025-01-01' AND DATE '2025-12-01'`                                                                                                                                                                                                                                                                                                                                                | `order_date BETWEEN DATE '2025-01-01' AND LAST_DAY(DATE '2025-12-01', MONTH)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Aggregation                                       | Filter before aggregation                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | SELECT *<br>FROM (<br>  SELECT event_date, COUNT(*) AS total<br>  FROM `project.dataset.events`<br>  GROUP BY event_date<br>)<br>WHERE event_date >= '2025-11-01';                                                                                                                                                                                                                                                            | SELECT event_date, COUNT(*) AS total<br>FROM `project.dataset.events`<br>WHERE event_date >= '2025-11-01'<br>GROUP BY event_date;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| Joins                                             | Largest table first<br>BigQuery best practice is to manually place the largest table first, followed by the smallest, and then by decreasing size. Only under specific table conditions does BigQuery automatically reorder/optimize based on table size.                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|                                                   | Filter before joins<br>WHERE clauses should be executed as soon as possible, especially within joins, so the tables to be joined are as small as possible. We recommend reviewing the query execution details to see if filtering is happening as early as possible, and either fix the condition or use a subquery to filter in advance of a JOIN.                                                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|                                                   | Pre-aggregate to limit table size<br>aggregating tables before they are joined can help improve performance - but only if the amount of data being joined is drastically reduced and tables are aggregated to the same level (i.e., if there is only one row for every join key value)                                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|                                                   | Join on cluster keys/Clustering on join keys:<br>When you cluster a table based on the key that is used to join, the data is already co-located which makes it easier for workers to split the data into the necessary partitions within the memory shuffle.                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| CTE/View                                          | Materialize CTE/view if it is used multiple times<br><br><br>In some database engines, regular CTEs and views are materialized<br>- For eg, DuckDB's query optimizer automatically decides whether to materialize a CTE or inline it into the main query, based on heuristics<br><br>In some database engines, Regular CTEs and views<br>- For eg, bigquery<br>- are like macros<br>	- textual substitution/inline expansion of code at query time<br>- They are not materialized even if they are referenced multiple times<br>	- If a non-recursive CTE is referenced in multiple places in a query, then the CTE is executed once for each reference.<br>	- BigQuery only materializes the results of recursive CTEs | WITH<br>cte AS (<br>SELECT<br>  a.name,<br>  b.state,<br>  RAND() AS random,<br>FROM `bigquery-public-data.usa_names.usa_1910_2013` a<br>LEFT JOIN `bigquery-public-data.usa_names.usa_1910_2013` b<br>  USING (number)<br>LIMIT 10<br>)<br><br><br><br><br><br><br><br><br><br>SELECT * FROM cte<br>UNION ALL SELECT * FROM cte<br>UNION ALL SELECT * FROM cte<br>UNION ALL SELECT * FROM cte<br>UNION ALL SELECT * FROM cte | WITH RECURSIVE<br>cte AS (<br>SELECT<br>  a.name,<br>  b.state,<br>  RAND() AS random,<br>FROM `bigquery-public-data.usa_names.usa_1910_2013` a<br>LEFT JOIN `bigquery-public-data.usa_names.usa_1910_2013` b<br>  USING (number)<br>LIMIT 10<br>),<br><br>my_cte_materialized AS (<br>SELECT * FROM `dulcet-antler-481417-p8.test.view_name`<br><br>UNION ALL (SELECT * FROM my_cte_materialized WHERE FALSE)<br>)<br><br>SELECT * FROM my_cte_materialized<br>UNION ALL SELECT * FROM my_cte_materialized<br>UNION ALL SELECT * FROM my_cte_materialized<br>UNION ALL SELECT * FROM my_cte_materialized<br>UNION ALL SELECT * FROM my_cte_materialized |
| Filtering<br>First or last record<br>without join | When trying to calculate the first or last record in a subset of your data, using the ROW_NUMBER() function can fail with Resources Exceeded errors if there are too many elements to ORDER BY in a single partition.<br><br>Instead, try using ARRAY_AGG() - which runs more efficiently because the ORDER BY is allowed to drop everything except the top record on each GROUP BY<br><br>This is because there is no join here, so group by is faster than window function<br><br>                                                                                                                                                                                                                                    | select <br>  * except(rn)<br>from (<br>  select *, <br>    row_number() over(<br>      partition by name<br>      order by number desc) rn<br>  from <br>    `bigquery-public-data.usa_names.usa_1910_2013` t<br>)<br>where rn = 1                                                                                                                                                                                            | select  <br>  event.* <br>from (<br>  select array_agg(<br>    t order by number desc limit 1<br>  )[offset(0)] event<br>  from <br>    `bigquery-public-data.usa_names.usa_1910_2013` t<br>  group by <br>    name<br>)                                                                                                                                                                                                                                                                                                                                                                                                                                 |
## Materialized CTE/View


Trade-off

|                     | Materialization | Macro |
| ------------------- | --------------- | ----- |
| Lower elapsed time  | ✅               |       |
| Lower slot-time     |                 | ✅     |
| Lower data reading  | ✅               |       |
| Lower data shuffled | ✅               |       |

## De-Duplicating Data

In order of performance

- `QUALIFY`
	- `QUALIFY ROW_NUMBER() OVER (PARTITION BY foi.order_id ORDER BY NULL) = 1`
		- No need of `ORDER BY`
- `GROUP BY` and `ANY_VALUE`
- `GROUP BY ALL`
- `DISTINCT`
